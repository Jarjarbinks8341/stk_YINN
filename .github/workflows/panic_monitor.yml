name: YINN Hourly Panic Monitor

on:
  schedule:
    # Runs at the start of every hour from 14:00 to 21:00 UTC (weekdays)
    - cron: '0 14-21 * * 1-5'
  workflow_dispatch: # Allow manual triggers

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check Market Status and Hour
      id: check_market
      run: |
        # Use Python to set clean output variables
        python -c "
import datetime, pytz, os
from is_market_open import is_market_open
tz = pytz.timezone('US/Eastern')
now_et = datetime.datetime.now(pytz.utc).astimezone(tz)
is_open = is_market_open()

with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
    f.write(f'open={str(is_open).lower()}\n')
    f.write(f'hour_et={now_et.hour}\n')
    f.write(f'is_opening_report={str(now_et.hour == 10).lower()}\n')
        "

    - name: Initialize Database and Update Data
      if: steps.check_market.outputs.open == 'true'
      run: |
        python update_daily.py

    - name: Run Panic Put Seller Strategy
      if: steps.check_market.outputs.open == 'true'
      id: run_panic
      run: |
        python panic_put_seller.py > output.txt
        cat output.txt
        
        # Determine if we should send a notification
        if grep -q "ðŸš¨ YINN PANIC ALERT ðŸš¨" output.txt; then
            echo "send_notif=true" >> $GITHUB_OUTPUT
        elif [ "${{ steps.check_market.outputs.is_opening_report }}" == "true" ]; then
            echo "send_notif=true" >> $GITHUB_OUTPUT
        else
            echo "send_notif=false" >> $GITHUB_OUTPUT
        fi
        
        # Capture report content safely
        EOF_DELIMITER=$(dd if=/dev/urandom bs=15 count=1 2>/dev/null | base64)
        echo "report<<$EOF_DELIMITER" >> $GITHUB_OUTPUT
        cat output.txt >> $GITHUB_OUTPUT
        echo "$EOF_DELIMITER" >> $GITHUB_OUTPUT

    - name: Send Notification
      if: steps.run_panic.outputs.send_notif == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python send_notif.py "${{ steps.run_panic.outputs.report }}"

    - name: Skip if Market Closed
      if: steps.check_market.outputs.open == 'false'
      run: |
        echo "The New York Stock Exchange is closed right now. Skipping strategy run."
