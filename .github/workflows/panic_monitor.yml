name: YINN Hourly Panic Monitor

on:
  schedule:
    # Runs at the start of every hour from 14:00 to 21:00 UTC (weekdays)
    - cron: '0 14-21 * * 1-5'
  workflow_dispatch: # Allow manual triggers

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check Market Status and Hour
      id: check_market
      run: |
        # Check if market is open and if this is the 10 AM ET opening report
        # We'll use a python script for the full check to avoid shell exit code issues
        RESULT=$(python -c "
import datetime, pytz, sys
from is_market_open import is_market_open
tz = pytz.timezone('US/Eastern')
now_et = datetime.datetime.now(pytz.utc).astimezone(tz)
is_open = is_market_open()
print(f'open={str(is_open).lower()}')
print(f'hour_et={now_et.hour}')
        ")
        echo "$RESULT" >> $GITHUB_OUTPUT
        
        # Check if it's the 10 AM ET hour
        HOUR_ET=$(python -c "import datetime, pytz; print(datetime.datetime.now(pytz.utc).astimezone(pytz.timezone('US/Eastern')).hour)")
        if [ "$HOUR_ET" -eq 10 ]; then
          echo "is_opening_report=true" >> $GITHUB_OUTPUT
        else
          echo "is_opening_report=false" >> $GITHUB_OUTPUT
        fi

    - name: Initialize Database and Update Data
      if: steps.check_market.outputs.open == 'true'
      run: |
        python update_daily.py

    - name: Run Panic Put Seller Strategy
      if: steps.check_market.outputs.open == 'true'
      id: run_panic
      run: |
        python panic_put_seller.py > output.txt
        cat output.txt
        
        # Determine if we should send a notification
        # 1. It's a Panic Alert
        # 2. It's the 10 AM Opening Report (even if no panic)
        if grep -q "ðŸš¨ YINN PANIC ALERT ðŸš¨" output.txt; then
            echo "send_notif=true" >> $GITHUB_OUTPUT
        elif [ "${{ steps.check_market.outputs.is_opening_report }}" == "true" ]; then
            echo "send_notif=true" >> $GITHUB_OUTPUT
        else
            echo "send_notif=false" >> $GITHUB_OUTPUT
        fi
        
        # Use a more unique delimiter for multiline strings in GITHUB_OUTPUT
        EOF_DELIMITER=$(dd if=/dev/urandom bs=15 count=1 2>/dev/null | base64)
        echo "report<<$EOF_DELIMITER" >> $GITHUB_OUTPUT
        cat output.txt >> $GITHUB_OUTPUT
        echo "$EOF_DELIMITER" >> $GITHUB_OUTPUT

    - name: Send Notification
      if: steps.run_panic.outputs.send_notif == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python send_notif.py "${{ steps.run_panic.outputs.report }}"

    - name: Skip if Market Closed
      if: steps.check_market.outputs.open == 'false'
      run: |
        echo "The New York Stock Exchange is closed right now. Skipping strategy run."
